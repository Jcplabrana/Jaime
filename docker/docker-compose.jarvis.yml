# ============================================
# OpenClaw Jarvis Edition - Docker Services
# PostgreSQL 16 + Redis 7 + Brain API
# ============================================

services:
  # ---- PostgreSQL 16 ----
  jarvis-postgres:
    image: postgres:16-alpine
    container_name: jarvis-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-jarvis}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-jarvis_secret_2026}
      POSTGRES_DB: ${POSTGRES_DB:-jarvis_brain}
    volumes:
      - jarvis-pg-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-jarvis}"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 2G

  # ---- Redis 7 ----
  jarvis-redis:
    image: redis:7-alpine
    container_name: jarvis-redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-jarvis_redis_2026}
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
    volumes:
      - jarvis-redis-data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-jarvis_redis_2026}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 768M

  # ---- Brain API (FastAPI) ----
  jarvis-brain:
    build:
      context: ../brain-api
      dockerfile: Dockerfile
    container_name: jarvis-brain
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-jarvis}:${POSTGRES_PASSWORD:-jarvis_secret_2026}@jarvis-postgres:5432/${POSTGRES_DB:-jarvis_brain}
      REDIS_URL: redis://:${REDIS_PASSWORD:-jarvis_redis_2026}@jarvis-redis:6379/0
      OLLAMA_BASE_URL: http://${OLLAMA_HOST_IP:-host.docker.internal}:11434
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-mxbai-embed-large}
      LOG_LEVEL: ${LOG_LEVEL:-info}
    ports:
      - "${BRAIN_API_PORT:-8000}:8000"
    depends_on:
      jarvis-postgres:
        condition: service_healthy
      jarvis-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3

volumes:
  jarvis-pg-data:
    driver: local
  jarvis-redis-data:
    driver: local

networks:
  default:
    name: jarvis-network
